---
title: "Descriptive and univariate analyses"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, echo = FALSE, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(readr)
library(dplyr)
library(ggpubr)
library(patchwork)
library(sjmisc)
library(sjlabelled)
library(tableone)
library(stringr)
library(kableExtra)
library(nlme)
library(lme4)
library(gamlj)

# NOTES
# bl_int_4 = Education levels (re-coded for ease)
# 1 = no education, 2 = primary, 3 = secondary, 4 = university, 5 = grad school, 6 = other

# bl_int_2 = Marital status
## 1 = Single; 2 = Married/living with partner; 3 = Separated or divorced; 4 = Widow or widower

# bl_int_6 = Ethnicity
# Aboriginal - 1, Arab - 2, African - 3, Black - 4, Chinese - 5, Filipino - 6, Hispanic - 7, Jamaican - 8, Japanese - 9, Korean - 10, Metis - 11, White - 12, West Asian (Iranian, Afghan, etc.) - 13, Southeast Asian (Vietnamese, Cambodian, etc.) - 14, South Asian (Sri Lankan, East Indian, etc.) - 15, Other: - 16, Refused - 17, Don`t know - 18

# 1 = White/Caucasian = 12
# 2 = Black, Caribbean, African = 3, 4, 8 
# 3 = Asian = 5, 6, 9, 10, 13, 14, 15
# 4 = Hispanic = 7
# 5 = Native = 1, 11
# 6 = Other/multi = 2, 16, 17, 18 or >18

# bl_int_9 = Employment
# 1 = Working full time; 2 = Working part time; 3 = Temporarily laid off; 4 = Unemployed
# 5 = Retired; 6 = Homemaker; 7 = Student; 8 = On disability; 9 = Volunteering 
# 10 = Working with modified tasks; 11, On leave with pay; 12 = On leave without pay; 13 = On welfare

# NEED clin_path_8 for tumor grade

```

```{r echo=FALSE, message=FALSE}
data <- read_csv("data/mtl_scored_apr2023.csv") %>%
  filter(gender %in% c("FEMALE", "MALE")) %>%
  filter(age_y > 15) %>%
  mutate(bl_int_6 = str_replace(bl_int_6, "\\;", ""),
         bl_int_4 = factor(case_when(bl_int_4 == 1 ~ 1,
                                     bl_int_4 == 2 ~ 2,
                                     bl_int_4 == 3 | bl_int_4 == 4 | bl_int_4 == 5 | bl_int_4 == 6 | bl_int_4 == 7 | bl_int_4 == 8 ~ 3,
                                     bl_int_4 == 9 | bl_int_4 == 10 | bl_int_4 == 11 ~ 4,
                                     bl_int_4 == 12 | bl_int_4 == 13 ~ 5,
                                     bl_int_4 == 14 ~ 6)),
         education = case_when(bl_int_4 == "1" ~ "No education",
                               bl_int_4 == "2" ~ "Primary",
                               bl_int_4 == "3" ~ "Secondary",
                               bl_int_4 == "4" ~ "University",
                               bl_int_4 == "5" ~ "Grad school",
                               bl_int_4 == "6" ~ "Other"),
         bl_int_6 = factor(case_when(bl_int_6 == 12 ~ 1,
                                     bl_int_6 == 3 | bl_int_6 == 4 | bl_int_6 == 8 ~ 2,
                                     bl_int_6 == 5 | bl_int_6 == 6 | bl_int_6 == 9 |
                                       bl_int_6 == 10 | bl_int_6 == 13 |bl_int_6 == 14 |
                                       bl_int_6 == 15 ~ 3,
                                     bl_int_6 == 7 ~ 4,
                                     bl_int_6 == 1 | bl_int_6 == 11 ~ 5,
                                     bl_int_6 == 2 | bl_int_6 > 15 ~ 6)),
         ethnicity = case_when(bl_int_6 == "1" ~ "Caucasian/White",
                               bl_int_6 == "2" ~ "Black/Carribbean/African",
                               bl_int_6 == "3" ~ "Asian",
                               bl_int_6 == "4" ~ "Hispanic",
                               bl_int_6 == "5" ~ "Native",
                               bl_int_6 == "6" ~ "Other/Multiple"),
         marital = case_when(bl_int_2 == 1 ~ "Single",
                             bl_int_2 == 2 ~ "Married/Cohabiting",
                             bl_int_2 == 3 ~ "Separated/Divorced",
                             bl_int_2 == 4 ~ "Widowed"),
         bl_deceased = case_when(bl_deceased == "No" ~ "No",
                                 bl_deceased == "Unknown" ~ "No",
                                 bl_deceased == "Yes" ~ "Yes"),
         tumor_location = case_when(bl_le_tessscore_sc >= 0 ~ "lower",
                              bl_ue_tessscore_sc >= 0 ~ "upper")) %>%
  mutate(change_function = ifelse(bl_agreement_function == m12_agreement_function, "No change", "Change"),
         change_pain = ifelse(bl_agreement_pain == m12_agreement_pain, "No change", "Change"))

```

## Notes

-   Only cases diagnosed at age 16 or later are included (consent)
-   clin_path_8 = tumor grade
-   tumor type = 1 Soft tissue, 2 Bone
-   bl_deceased = passed before surgical intervention

### Variables

EXPECTATIONS ABOUT OUTCOMES AT BASELINE

**How long do you think it will take you to recover from your treatment
for your arm or leg problem?** (bl_ioe_recover_time)

1 = 3 months

2 = 6, 12, 24 months

3 = I do not expect a full recovery

4 = I don\`t know what to expect

**Do you expect to experience any complications from your treatment?**
(bl_ioe_complication)

1 = No

3 = Yes

4 = I don\`t know what to expect

**In general, how difficult do you expect your daily activities to be
once you recover from the treatment for your arm or leg problem?**
(bl_ioe_recover_difficulty)

1 = Not at all difficult

2 = Somewhat difficult

3 = Extremely difficult

4 = I don\`t know what to expect

## SAMPLE

```{r echo=FALSE, warning=FALSE, message=FALSE}
var_sample <- c("gender", "age_y", "bl_tumour_type", "tumor_location", "clin_path_8", "marital", "education", "ethnicity", "bl_deceased", "bl_optimism", "bl_pessimism", "bl_tess", "bl_facit_score", "bl_qol_7", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

# Determine which variables are categorical
cat_vars_sample <- c("gender", "bl_tumour_type", "tumor_location", "clin_path_8","marital", "education", "ethnicity", "bl_deceased", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

#All cases table
table_sample <- CreateTableOne(vars = var_sample, 
                          factorVars = cat_vars_sample,
                          data = data)
table_sample
```

### Analyses

#### Table for differences in agreement on function based on demographic and medical factors

AGREEMENT on Function

Stratification by: 1 = Patient and doctor agree 0 = Patient and doctor
disagree

Positive agreement on function was associated with tumor grade, whether
or not patient passed before surgery (also related to tumor grade = more
invasive cancer), with better baseline function, fatigue, QOL, and
patient's expectations about the time it would take them to recover (a
larger proportion of those who agreed with doctor expected to recover in
no time).
```{r echo=FALSE}
univariate <- data %>%
  dplyr::select(subject_id, gender, 
                procedure, tumor_location, clin_path_8,
                area, bl_prez_5_1, bl_tess, bl_msts_extremity,
                bl_deceased, age_y, bl_tumour_type,
                bl_optimism, bl_pessimism,
                bl_int_9, bl_int_11,
                marital, education, ethnicity,
                bl_tess, bl_facit_score, bl_qol_7,
                bl_ioe_recover_time, bl_ioe_complication, bl_ioe_recover_difficulty,
                bl_agreement_function, bl_agreement_pain,
                m12_agreement_function, m12_agreement_pain,
                change_function, change_pain) 


# Create a list of variables to be looked at
var_list_1 <- c("gender", "age_y", "bl_tumour_type", "tumor_location", "clin_path_8", "marital", "education", "ethnicity", "bl_deceased", "bl_optimism", "bl_pessimism", "bl_tess", "bl_facit_score", "bl_qol_7", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

# Determine which variables are categorical
cat_vars_1 <- c("gender", "bl_tumour_type", "tumor_location", "clin_path_8","marital", "education", "ethnicity", "bl_deceased", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

#All cases table
table_1 <- CreateTableOne(vars = var_list_1, 
                          factorVars = cat_vars_1,
                          data = univariate,
                          strata = c("bl_agreement_function"))
table_1
```

#### Table for differences in agreement on pain based on demographic and medical factors

AGREEMENT on Pain

Stratification by: 1 = Patient and doctor agree 0 = Patient and doctor
disagree

Positive agreement with doctors on pain at baseline was associated with
tumor type, patient's optimism, higher baseline level of self-reported
functioning, quality of life and lower fatigue (FACIT scores are
reverse).

```{r echo=FALSE}

# Create a list of variables to be looked at
var_list_2 <- c("gender", "age_y", "bl_tumour_type", "tumor_location", "clin_path_8","marital", "education", "ethnicity", "bl_deceased", "bl_optimism", "bl_pessimism", "bl_tess", "bl_facit_score", "bl_qol_7", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

# Determine which variables are categorical
cat_vars_2 <- c("gender", "bl_tumour_type", "tumor_location", "clin_path_8", "marital", "education", "ethnicity", "bl_deceased", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

#All cases table
table_2 <- CreateTableOne(vars = var_list_2, 
                          factorVars = cat_vars_2,
                          data = univariate,
                          strata = c("bl_agreement_pain"))
table_2
```

### AGREEMENT OVER TIME (univariate analyses, descriptives)

```{r echo=FALSE}
data_analysis_change_agreement_function <- data %>%
  dplyr::select(subject_id, bl_level_agreement_function, m12_level_agreement_function) %>%
  pivot_longer(cols = c(bl_level_agreement_function, m12_level_agreement_function),
               names_to = "time",
               values_to = "score")
    
write_csv(data_analysis_change_agreement_function, "~/Desktop/change_agreement_function_apr14.csv")

data_analysis_change_agreement_pain <- data %>%
  dplyr::select(subject_id, bl_level_agreement_pain,m12_level_agreement_pain) %>%
  pivot_longer(cols = c(bl_level_agreement_pain,m12_level_agreement_pain),
               names_to = "time",
               values_to = "score")
    
write_csv(data_analysis_change_agreement_pain, "~/Desktop/change_agreement_pain_apr14.csv")

```

### Change in function from baseline to 1 year (dummy)

There is a very small correlation between baseline and 1 year agreement
on function. Dummy variable suggests that 58% see no change, but 42%
demonstrated change in agreement on function.

```{r echo=FALSE, warning=FALSE, message=FALSE}
data %>%
  dplyr::select(change_function) %>%
  group_by(change_function) %>%
  count() %>%
  drop_na() %>%
  ungroup() %>%
  mutate(sum = sum(n),
         Prop = (prop = round(n/sum,2)*100)) %>%
  dplyr::select(-sum) %>%
  kable() %>%
  kable_styling(full_width = FALSE)

ggscatter(data, x = "bl_level_agreement_function", y = "m12_level_agreement_function",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   ) + 
  stat_cor(method = "spearman", 
           label.x = 2, label.y = 4,
           p.accuracy = 0.001, r.accuracy = 0.01) +
  geom_jitter()
```

## Variables associated with change on function over time

The only variable associated with any change (positive of negative) was
baseline QOL.

```{r echo=FALSE}
var_list_3 <- c("gender", "age_y", "bl_tumour_type", "tumor_location", "clin_path_8", "marital", "education", "ethnicity", "bl_deceased", "bl_optimism", "bl_pessimism", "bl_tess", "bl_facit_score", "bl_qol_7", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

# Determine which variables are categorical
cat_vars_3 <- c("gender", "bl_tumour_type", "tumor_location", "clin_path_8","marital", "education", "ethnicity", "bl_deceased", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

#All cases table
table_3 <- CreateTableOne(vars = var_list_3, 
                          factorVars = cat_vars_3,
                          data = univariate,
                          strata = c("change_function"))
table_3
```

### Change in pain from baseline to 1 year (dummy)

There is literally no correlation between baseline and 1 year agreement
suggesting that some people agree more and others disagree more. Dummy
variably suggests that 55% see no change, but 45% demonstrated change in
agreement on pain.

```{r echo=FALSE, warning=FALSE, message=FALSE}
data %>%
  dplyr::select(change_pain) %>%
  group_by(change_pain) %>%
  count() %>%
  drop_na() %>%
  ungroup() %>%
  mutate(sum = sum(n),
         Prop = (prop = round(n/sum,2)*100)) %>%
  dplyr::select(-sum) %>%
  kable() %>%
  kable_styling(full_width = FALSE)

ggscatter(data, x = "bl_level_agreement_pain", y = "m12_level_agreement_pain",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   ) + 
  stat_cor(method = "spearman", 
           label.x = 2, label.y = 4,
           p.accuracy = 0.001, r.accuracy = 0.01) +
  geom_jitter()
```

## Variables associated with change on pain over time

Variables associated with change on agreement on pain were associated
(univariate) with baseline function scores, QOL and fatigue.

```{r echo= FALSE}
var_list_4 <- c("gender", "age_y", "bl_tumour_type", "tumor_location", "clin_path_8", "marital", "education", "ethnicity", "bl_deceased", "bl_optimism", "bl_pessimism", "bl_tess", "bl_facit_score", "bl_qol_7", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

# Determine which variables are categorical
cat_vars_4 <- c("gender", "bl_tumour_type", "tumor_location", "clin_path_8","marital", "education", "ethnicity", "bl_deceased", "bl_ioe_recover_time", "bl_ioe_complication", "bl_ioe_recover_difficulty")

#All cases table
table_4 <- CreateTableOne(vars = var_list_4, 
                          factorVars = cat_vars_4,
                          data = univariate,
                          strata = c("change_pain"))
table_4
```

## Outcomes over time based on agreement on function
```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=11}
data_over_time <- data %>%
  dplyr::select(subject_id, age_y, bl_level_agreement_pain, bl_level_agreement_function, bl_agreement_function, bl_agreement_pain, bl_tess, m12_tess, bl_qol_7, m12_qol_7, bl_facit_score, m12_facit_score) %>%
  drop_na(bl_agreement_function) %>%
  pivot_longer(cols = c(bl_tess, m12_tess, bl_qol_7, m12_qol_7, bl_facit_score, m12_facit_score),
               names_to = c("time", "measure"),
               names_sep = "_",
               values_to = "score")


data_over_time %>% 
  ggplot(aes(x = time, y = score)) +
  geom_boxplot(aes(fill = factor(bl_level_agreement_function))) +
  facet_grid(~measure)

data_over_time %>%
  ggplot(aes(x = time, y = score)) +
  geom_boxplot(aes(fill = factor(bl_agreement_function))) +
  facet_grid(~measure)
```

## Outcomes over time based on agreement on pain
```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=11}
data_over_time <- data %>%
  dplyr::select(subject_id, age_y, bl_level_agreement_pain, bl_level_agreement_function, bl_agreement_function, bl_agreement_pain, bl_tess, m12_tess, bl_qol_7, m12_qol_7, bl_facit_score, m12_facit_score) %>%
  drop_na(bl_agreement_function) %>%
  pivot_longer(cols = c(bl_tess, m12_tess, bl_qol_7, m12_qol_7, bl_facit_score, m12_facit_score),
               names_to = c("time", "measure"),
               names_sep = "_",
               values_to = "score")

data_over_time %>% 
  drop_na(bl_level_agreement_pain) %>%
  ggplot(aes(x = time, y = score)) +
  geom_boxplot(aes(fill = factor(bl_level_agreement_pain))) +
  facet_grid(~measure)

data_over_time %>% 
  drop_na(bl_agreement_pain) %>%
  ggplot(aes(x = time, y = score)) +
  geom_boxplot(aes(fill = factor(bl_agreement_pain))) +
  facet_grid(~measure)
```

## UNIVARIATE: OUTCOME = TESS
### based on agreement on function
```{r echo=FALSE}
data_mixed_change_tess <- data %>%
  dplyr::select(subject_id, bl_level_agreement_pain, bl_level_agreement_function, bl_agreement_function, bl_agreement_pain, bl_level_agreement_function_dummy, bl_level_agreement_pain_dummy, bl_tess, m12_tess) %>%
  pivot_longer(cols = c(bl_tess, m12_tess),
               names_to = "time",
               values_to = "score") %>%
  mutate(subject_id = as.numeric(subject_id),
         time = as.factor(time),
         bl_level_agreement_function_dummy = as.factor(bl_level_agreement_function_dummy),
         bl_agreement_function = as.factor(case_when(bl_agreement_function == 0 ~ "disagree", 
                                                     bl_agreement_function == 1 ~ "agree")),
         bl_agreement_pain = as.factor(case_when(bl_agreement_pain == 0 ~ "disagree",
                                                 bl_agreement_pain == 1 ~ "agree")))
    
# write_csv(data_mixed_change_tess, "~/Desktop/data_mixed_change_tess.csv")

gamlj::gamljMixed(
    formula = score ~ 1 + time + bl_agreement_function + time:bl_agreement_function+( 1 | subject_id ),
    data = data_mixed_change_tess,
    plotHAxis = time,
    plotSepLines = bl_agreement_function,
    plotError = "ci")
```

### What about agreement as 3-factor
```{r echo=FALSE}
gamlj::gamljMixed(
    formula = score ~ 1 + time + bl_level_agreement_function_dummy + time:bl_level_agreement_function_dummy+( 1 | subject_id ),
    data = data_mixed_change_tess,
    plotHAxis = time,
    plotSepLines = bl_level_agreement_function_dummy,
    plotError = "ci")
```


### based on agreement on pain
```{r echo=FALSE}
gamlj::gamljMixed(
    formula = score ~ 1 + time + bl_agreement_pain + time:bl_agreement_pain+( 1 | subject_id ),
    data = data_mixed_change_tess,
    plotHAxis = time,
    plotSepLines = bl_agreement_pain,
    plotError = "ci")
```

## UNIVARIATE: OUTCOME = Quality of Life
### based on agreement on function
```{r echo=FALSE}
data_mixed_change_qol <- data %>%
  dplyr::select(subject_id, bl_level_agreement_pain, bl_level_agreement_function, bl_agreement_function, bl_agreement_pain, bl_level_agreement_function_dummy, bl_level_agreement_pain_dummy, bl_qol_7, m12_qol_7) %>%
  pivot_longer(cols = c(bl_qol_7, m12_qol_7),
               names_to = "time",
               values_to = "score") %>%
  mutate(subject_id = as.numeric(subject_id),
         time = as.factor(time),
         bl_level_agreement_function_dummy = as.factor(bl_level_agreement_function_dummy),
         bl_agreement_function = as.factor(case_when(bl_agreement_function == 0 ~ "disagree", 
                                                     bl_agreement_function == 1 ~ "agree")),
         bl_agreement_pain = as.factor(case_when(bl_agreement_pain == 0 ~ "disagree",
                                                 bl_agreement_pain == 1 ~ "agree")))
    
gamlj::gamljMixed(
    formula = score ~ 1 + time + bl_level_agreement_function_dummy + time:bl_level_agreement_function_dummy + ( 1 | subject_id ),
    data = data_mixed_change_qol,
    plotHAxis = time,
    plotSepLines = bl_level_agreement_function_dummy,
    plotError = "ci")
```

### based on agreement on pain
```{r echo=FALSE}
gamlj::gamljMixed(
    formula = score ~ 1 + time + bl_agreement_pain + time:bl_agreement_pain+( 1 | subject_id ),
    data = data_mixed_change_qol,
    plotHAxis = time,
    plotSepLines = bl_agreement_pain,
    plotError = "ci")
```

## UNIVARIATE: OUTCOME = FATIGUE
### based on agreement on function
```{r echo=FALSE}
data_mixed_change_facit <- data %>%
  dplyr::select(subject_id, bl_level_agreement_pain, bl_level_agreement_function, bl_agreement_function, bl_agreement_pain, bl_level_agreement_function_dummy, bl_level_agreement_pain_dummy, bl_facit_score, m12_facit_score) %>%
  pivot_longer(cols = c(bl_facit_score, m12_facit_score),
               names_to = "time",
               values_to = "score") %>%
  mutate(subject_id = as.numeric(subject_id),
         time = as.factor(time),
         bl_agreement_function = as.factor(case_when(bl_agreement_function == 0 ~ "disagree", 
                                                     bl_agreement_function == 1 ~ "agree")),
         bl_agreement_pain = as.factor(case_when(bl_agreement_pain == 0 ~ "disagree",
                                                 bl_agreement_pain == 1 ~ "agree")))
    
gamlj::gamljMixed(
    formula = score ~ 1 + time + bl_agreement_function + time:bl_agreement_function+( 1 | subject_id ),
    data = data_mixed_change_facit,
    plotHAxis = time,
    plotSepLines = bl_agreement_function,
    plotError = "ci")
```
### based on agreement on pain
```{r echo=FALSE}
gamlj::gamljMixed(
    formula = score ~ 1 + time + bl_agreement_pain + time:bl_agreement_pain+( 1 | subject_id ),
    data = data_mixed_change_facit,
    plotHAxis = time,
    plotSepLines = bl_agreement_pain,
    plotError = "ci")
```
